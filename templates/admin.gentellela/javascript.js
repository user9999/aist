var $=jQuery.noConflict();$(document).ready(function(){jQuery.event.props.push('dataTransfer');var maxFiles=12;var errMessage=0;var defaultUploadBtn=$('#uploadbtn');var dataArray=[];$('#uploaded-files').hide();$('#drop-files').on('drop',function(e){var files=e.dataTransfer.files;if(files.length<=maxFiles){loadInView(files);}else{alert('Вы не можете загружать больше '+maxFiles+' изображений!');files.length=0;return;}});defaultUploadBtn.on('change',function(){var files=$(this)[0].files;if(files.length<=maxFiles){loadInView(files);$('#frm').each(function(){this.reset();});}else{alert('Вы не можете загружать больше '+maxFiles+' изображений!');files.length=0;}});function loadInView(files){$('#uploaded-holder').show();$.each(files,function(index,file){if(!files[index].type.match('image.*')){if(errMessage==0){$('#drop-files p').html('Эй! только изображения!');++errMessage}else if(errMessage==1){$('#drop-files p').html('Стоп! Загружаются только изображения!');++errMessage}else if(errMessage==2){$('#drop-files p').html("Только изображения!");++errMessage}else if(errMessage==3){$('#drop-files p').html("Только изображения!");errMessage=0;}return false;}if((dataArray.length+files.length)<=maxFiles){$('#upload-button').css({'display':'block'});}else{alert('Вы не можете загружать больше '+maxFiles+' изображений!');return;}var fileReader=new FileReader();fileReader.onload=(function(file){return function(e){dataArray.push({name:file.name,value:this.result});addImage((dataArray.length-1));};})(files[index]);fileReader.readAsDataURL(file);});return false;}function addImage(ind){if(ind<0){start=0;end=dataArray.length;}else{start=ind;end=ind+1;}if(dataArray.length==0){$('#upload-button').hide();$('#uploaded-holder').hide();}else if(dataArray.length==1){$('#upload-button span').html("Был выбран 1 файл");}else{$('#upload-button span').html(dataArray.length+" файлов были выбраны");}for(i=start;i<end;i++){if($('#dropped-files > .image').length<=maxFiles){$('#dropped-files').append('<div id="img-'+i+'" class="image" style="background: url('+dataArray[i].value+'); background-size: cover;"> <a href="#" id="drop-'+i+'" class="drop-button">Удалить изображение</a></div>');}}return false;}function restartFiles(){$('#loading-bar .loading-color').css({'width':'0%'});$('#loading').css({'display':'none'});$('#loading-content').html(' ');$('#upload-button').hide();$('#dropped-files > .image').remove();$('#uploaded-holder').hide();dataArray.length=0;return false;}$("#dropped-files").on("click","a[id^='drop']",function(){var elid=$(this).attr('id');var temp=new Array();temp=elid.split('-');dataArray.splice(temp[1],1);$('#dropped-files > .image').remove();addImage(-1);});$('#dropped-files #upload-button .delete').click(restartFiles);$('#upload-button .upload').click(function(){$("#loading").show();var totalPercent=100/dataArray.length;var x=0;$('#loading-content').html('Загружен '+dataArray[0].name);$.each(dataArray,function(index,file){$.post('/ajax/upload.php',dataArray[index],function(data){var fileName=dataArray[index].name;++x;$('#loading-bar .loading-color').css({'width':totalPercent*(x)+'%'});if(totalPercent*(x)==100){$('#loading-content').html('Загрузка завершена!!!');setTimeout(restartFiles,1000);}else if(totalPercent*(x)<100){$('#loading-content').html('Загружается '+fileName);}var dataSplit=data.split(':');if(dataSplit[1]=='загружен успешно'){$('#uploaded-files').append('<li><a href="/uploaded/gallery/'+dataSplit[0]+'">'+fileName+'</a> загружен успешно</li>');}else{$('#uploaded-files').append('<li><a href="/uploaded/gallery/'+data+'. Имя файла: '+dataArray[index].name+'</li>');}});});$('#uploaded-files').show();return false;});$('#drop-files').on('dragenter',function(){$(this).css({'box-shadow':'inset 0px 0px 20px rgba(0, 0, 0, 0.1)','border':'4px dashed #bb2b2b'});return false;});$('#drop-files').on('drop',function(){$(this).css({'box-shadow':'none','border':'4px dashed rgba(0,0,0,0.2)'});return false;});});